name: 🛳️ Create Release for gitctx

on:
    workflow_dispatch:
    workflow_call:

jobs:
    prepare-release:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.parse_version.outputs.VERSION }}
        steps:
            # Parse the version from the tag
            - name: Parse Version
              id: parse_version
              run: |
                # Extract version from the TAG
                echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
  
    build-and-deploy-release:
        runs-on: ubuntu-latest
        needs: prepare-release
        permissions:
            contents: write  # This allows creating releases
        steps:
            
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v31
              with:
                github_access_token: ${{ secrets.GITHUB_TOKEN }}
                extra_nix_config: |
                    max-jobs = auto
                    cores = 0

            - name: Install DevBox
              uses: jetpack-io/devbox-install-action@v0.13.0
              with:
                enable-cache: true

            - name: Create executables
              run: devbox run deploy

            # Upload the .deb package to a new newly created release
            - name: Create GitHub Release with binary
              uses: softprops/action-gh-release@v2
              with:
                name: v${{ needs.prepare-release.outputs.version }}
                files: ./dist/executables/gitctx-*